<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Loopers and Handlers in Android - xizzhu</title><meta name=description content="Looper and Handler are one of the key low-level components of Android. For example, the UI thread is built with them. However, only a few developers use them directly nowadays. In this article, we&rsquo;ll try to understand how they work."><meta name=author content="Xizhi Zhu"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"xizzhu","url":"https:\/\/xizzhu.me\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/xizzhu.me\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/xizzhu.me\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/xizzhu.me\/post\/2020-05-09-android-looper-handler\/","name":"Loopers and handlers in android"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Xizhi Zhu"},"headline":"Loopers and Handlers in Android","description":"Looper and Handler are one of the key low-level components of Android. For example, the UI thread is built with them. However, only a few developers use them directly nowadays. In this article, we\u0026rsquo;ll try to understand how they work.\n","inLanguage":"en","wordCount":1272,"datePublished":"2020-05-09T00:00:00","dateModified":"2020-05-09T00:00:00","image":"https:\/\/xizzhu.me\/images\/logo.png","keywords":["android"],"mainEntityOfPage":"https:\/\/xizzhu.me\/post\/2020-05-09-android-looper-handler\/","publisher":{"@type":"Organization","name":"https:\/\/xizzhu.me\/","logo":{"@type":"ImageObject","url":"https:\/\/xizzhu.me\/images\/logo.png","height":60,"width":60}}}</script><meta property="og:title" content="Loopers and Handlers in Android"><meta property="og:description" content="Looper and Handler are one of the key low-level components of Android. For example, the UI thread is built with them. However, only a few developers use them directly nowadays. In this article, we&rsquo;ll try to understand how they work."><meta property="og:image" content="https://xizzhu.me/images/logo.png"><meta property="og:url" content="https://xizzhu.me/post/2020-05-09-android-looper-handler/"><meta property="og:type" content="website"><meta property="og:site_name" content="xizzhu"><meta name=twitter:title content="Loopers and Handlers in Android"><meta name=twitter:description content="Looper and Handler are one of the key low-level components of Android. For example, the UI thread is built with them. However, only a few developers use them directly nowadays. In this article, …"><meta name=twitter:image content="https://xizzhu.me/images/logo.png"><meta name=twitter:card content="summary"><link href=https://xizzhu.me/images/logo.png rel=icon type=image/x-icon><meta name=generator content="Hugo 0.83.1"><link rel=alternate href=https://xizzhu.me/index.xml type=application/rss+xml title=xizzhu><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://xizzhu.me/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://xizzhu.me/css/syntax.css><link rel=stylesheet href=https://xizzhu.me/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-128400000-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://xizzhu.me/>xizzhu</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=About href=/pages/about/>About</a></li><li><a title=Posts href=/post>Posts</a></li><li><a title=Bible href=/bible>Bible</a></li><li><a title=随笔 href=/%e9%9a%8f%e7%ac%94>随笔</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=xizzhu href=https://xizzhu.me/><img class=avatar-img src=https://xizzhu.me/images/logo.png alt=xizzhu></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Loopers and Handlers in Android</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on May 9, 2020
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Xizhi Zhu</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><code>Looper</code> and <code>Handler</code> are one of the key low-level components of Android. For example, the UI thread is built with them. However, only a few developers use them directly nowadays. In this article, we&rsquo;ll try to understand how they work.</p><h3 id=brief-overview>Brief overview</h3><p>The <a href=https://developer.android.com/reference/android/os/Looper>Looper</a> class is essentially an event loop for a thread. There can be at most one <code>Looper</code> per thread.</p><p>For each <code>Looper</code>, there is exactly one <a href=https://developer.android.com/reference/android/os/MessageQueue>MessageQueue</a>, which holds the list of messages to be dispatched. We rarely need to use this class directly.</p><p>For most of the time, we use the <a href=https://developer.android.com/reference/android/os/Handler>Handler</a> class to send messages to a <code>Looper</code>, and handles the messages when dispatched. There can be as many <code>Handler</code>s as we want for any <code>Looper</code>.</p><p>Sitting on top of them, the <a href=https://developer.android.com/reference/android/os/HandlerThread>HandlerThread</a> provides a thread with a <code>Looper</code>. Let&rsquo;s start from this class.</p><h3 id=handlerthread>HandlerThread</h3><p>The following code shows how to use a <code>HandlerThread</code> in a very basic way:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>val</span> handlerThread = HandlerThread(<span style=color:#e6db74>&#34;my handler thread&#34;</span>)

<span style=color:#75715e>// need to call start() to start the thread
</span><span style=color:#75715e></span>handlerThread.start()

<span style=color:#66d9ef>val</span> handler = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>:  </span><span style=color:#a6e22e>Handler</span>(handlerThread.looper) {
    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>handleMessage</span>(msg: Message) {
        println(<span style=color:#e6db74>&#34;handle message: </span><span style=color:#e6db74>$msg</span><span style=color:#e6db74>&#34;</span>)
    }
}

<span style=color:#75715e>// the messages will be handled by Handler.handleMessage()
</span><span style=color:#75715e></span>handler.sendMessage(Message.obtain(handler, <span style=color:#ae81ff>777</span>))

<span style=color:#75715e>// the runnable will just run
</span><span style=color:#75715e></span>handler.post { println(<span style=color:#e6db74>&#34;a runnable&#34;</span>) }</code></pre></div></p><p>As we can see here, there are two main types of messages: a <code>Message</code> that will be handled by the <code>Handler</code>, or a <code>Runnable</code> that will just run. We will discuss later how the messages are dispatched in more detail.</p><p>A <code>HandlerThread</code> runs as long as the <code>Looper</code> is running. There are two methods to stop the event loop and end the thread:</p><ol><li><code>quit()</code>: discard all messages, and immediately quit the event loop.</li><li><code>quitSafely()</code>: dispatch all messages that are already due, and then quit.</li></ol><h3 id=handler>Handler</h3><h4 id=send-messages>Send messages</h4><p>As seen in the previous section, there are two main types of messages that <code>Handler</code> can handle. When the user posts a <code>Runnable</code>, it will first be wrapped into a <code>Message</code>:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Handler</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>post</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
       <span style=color:#66d9ef>return</span>  sendMessageDelayed<span style=color:#f92672>(</span>getPostMessage<span style=color:#f92672>(</span>r<span style=color:#f92672>),</span> 0<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Message <span style=color:#a6e22e>getPostMessage</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Message m <span style=color:#f92672>=</span> Message<span style=color:#f92672>.</span><span style=color:#a6e22e>obtain</span><span style=color:#f92672>();</span>
        m<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>=</span> r<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>return</span> m<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#f92672>...</span>
<span style=color:#f92672>}</span></code></pre></div></p><p>Then it goes through the same code path as a regular <code>Message</code>, and eventually asks the <code>MessageQueue</code> to enqueue it:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>enqueueMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> MessageQueue queue<span style=color:#f92672>,</span> <span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>,</span>
        <span style=color:#66d9ef>long</span> uptimeMillis<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>workSourceUid</span> <span style=color:#f92672>=</span> ThreadLocalWorkSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getUid</span><span style=color:#f92672>();</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mAsynchronous<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setAsynchronous</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>return</span> queue<span style=color:#f92672>.</span><span style=color:#a6e22e>enqueueMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> uptimeMillis<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span></code></pre></div></p><h4 id=handle-messages>Handle messages</h4><p>When <code>Looper</code> dispatches a message, <code>Handler.dispatchMessage()</code> will be called (modified for the sake of simplicity):<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispatchMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Message msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// if the Message is a Runnable, run it
</span><span style=color:#75715e></span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>callback</span><span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mCallback <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// if the Handler has a Callback (set in constructor),
</span><span style=color:#75715e></span>            <span style=color:#75715e>// try using it to handle the message
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mCallback<span style=color:#f92672>.</span><span style=color:#a6e22e>handleMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
        <span style=color:#75715e>// as a last resort, calls handleMessage()
</span><span style=color:#75715e></span>        handleMessage<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span></code></pre></div></p><p>Note that the <code>dispatchMessage()</code> method is NOT <code>final</code>. So when subclassing <code>Handler</code>, don&rsquo;t confuse it with <code>handleMessage()</code>.</p><h3 id=looper>Looper</h3><p>To create our own thread with a <code>Looper</code>, we can take the <code>HandlerThread</code> as a <a href=https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/os/HandlerThread.java>reference</a>:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HandlerThread</span> <span style=color:#66d9ef>extends</span> Thread <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        mTid <span style=color:#f92672>=</span> Process<span style=color:#f92672>.</span><span style=color:#a6e22e>myTid</span><span style=color:#f92672>();</span>
        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepare</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            mLooper <span style=color:#f92672>=</span> Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>();</span>
            notifyAll<span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>setThreadPriority</span><span style=color:#f92672>(</span>mPriority<span style=color:#f92672>);</span>
        onLooperPrepared<span style=color:#f92672>();</span>
        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
        mTid <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#f92672>...</span>
<span style=color:#f92672>}</span></code></pre></div></p><p>The most important things here are: 1) call <code>Looper.prepare()</code> to initialize the looper; 2) call <code>Looper.loop()</code> to run the event loop.</p><p>The <code>prepare()</code> method basically ensures there is at most one <code>Looper</code> per thread, stores the created <code>Looper</code> in a <code>ThreadLocal</code>, and creates a <code>MesssageQueue</code>:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Looper</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepare</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        prepare<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepare</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> quitAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Only one Looper may be created per thread&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        sThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Looper<span style=color:#f92672>(</span>quitAllowed<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Looper</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> quitAllowed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        mQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MessageQueue<span style=color:#f92672>(</span>quitAllowed<span style=color:#f92672>);</span>
        mThread <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#f92672>...</span>
<span style=color:#f92672>}</span></code></pre></div></p><p>Here, the <code>quitAllowed</code> flag is <code>true</code> for all the loopers in worker threads, meaning we can quit the event loop by calling <code>quit()</code> or <code>quitSafely()</code>.</p><p>The flag is <code>false</code> only for the main thread for obvious reasons. Note that we should never call <code>Looper.prepareMainLooper()</code> to mark current thread&rsquo;s looper as the main looper. Fortunately, this method is finally makes as deprecated in R.</p><p>After the looper is initialized, we need to call the <code>loop()</code> method to start the event loop, which has quite some logging code. However, the most interesting part is quite easy to understand, as shown below (modified for the sake of simplicity):<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>final</span> MessageQueue queue <span style=color:#f92672>=</span> myLooper<span style=color:#f92672>().</span><span style=color:#a6e22e>mQueue</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// fetches the next message to process
</span><span style=color:#75715e></span>        Message msg <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span> <span style=color:#75715e>// might block
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// No message indicates that the message queue is quitting.
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>// dispatches the message
</span><span style=color:#75715e></span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>target</span><span style=color:#f92672>.</span><span style=color:#a6e22e>dispatchMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>

        <span style=color:#75715e>// recycles the message
</span><span style=color:#75715e></span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>recycleUnchecked</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span></code></pre></div></p><h3 id=messagequeue>MessageQueue</h3><p><code>MessageQueue</code> has two main methods:</p><ol><li><code>enqueueMessage()</code>: called by <code>Handler</code> to add messages to the queue, and wake up the queue if currently blocked.</li><li><code>next()</code>: called by <code>Looper</code> to get the next message to dispatch. If there is no message to dispatch, it will block waiting for messages.</li></ol><h4 id=idlehandler>IdleHandler</h4><p>One thing interesting here is, when the <code>MessageQueue</code> is going to block waiting for more messages to dispatch, it will first run <a href=https://developer.android.com/reference/android/os/MessageQueue.IdleHandler>IdleHandlers</a>.</p><p>This is quite useful, when e.g. you need to do something on the main thread, but want to do it only when it&rsquo;s idle. For example, <code>ActivityThread</code> uses this technique to <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/app/ActivityThread.java;l=2098">schedule garbage collection</a></p><h3 id=use-case-ipc>Use case: IPC</h3><p>IPC (inter-process communication) is one of the most common use cases for <code>Looper</code> and <code>Handler</code>, with the help of <a href=https://developer.android.com/reference/android/os/Messenger>Messenger</a>. Under the hood, the <code>Messenger</code> class is simply a wrapper around a <code>Binder</code>, which is used to perform the communication.</p><p>First, we create a remote service like below:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RemoteService</span> : Service() {
    <span style=color:#75715e>// the Handler to handle the messages
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> handler = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>Handler</span>() {
        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>handleMessage</span>(msg: Message) {
            println(<span style=color:#e6db74>&#34;Message: </span><span style=color:#e6db74>$msg</span><span style=color:#e6db74>&#34;</span>)
        }
    }

    <span style=color:#75715e>// the created Messenger will dispatch incoming messages to the handlers
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> messenger = Messenger(handler)

    <span style=color:#75715e>// when someone binds to the service, we return the IBinder backing the
</span><span style=color:#75715e></span>    <span style=color:#75715e>// messenger, so that the peer can use to send messages
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onBind</span>(intent: Intent?): IBinder? = messenger.binder
}</code></pre></div></p><p>And we declare the service in <code>AndroidManifest.xml</code>:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style=color:#f92672>&lt;manifest</span> <span style=color:#960050;background-color:#1e0010>...</span><span style=color:#f92672>&gt;</span>

    <span style=color:#f92672>&lt;application</span> <span style=color:#960050;background-color:#1e0010>...</span> <span style=color:#f92672>&gt;</span>
        <span style=color:#f92672>&lt;service</span>
            <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;.RemoteService&#34;</span>
            <span style=color:#a6e22e>android:process=</span><span style=color:#e6db74>&#34;:remote_service&#34;</span> <span style=color:#f92672>/&gt;</span>
    <span style=color:#f92672>&lt;/application&gt;</span>

<span style=color:#f92672>&lt;/manifest&gt;</span></code></pre></div></p><p>One thing worth mentioning here is that, no matter whether the service is running in its own process, the code to send and receive messages stay the same.</p><p>And finally, we can bind to the service and send messages to it:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainActivity</span> : Activity() {
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> messenger: Messenger? = <span style=color:#66d9ef>null</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> connection = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>ServiceConnection</span> {
        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceConnected</span>(name: ComponentName, service: IBinder) {
            <span style=color:#75715e>// when the service is connected, we create the Messenger to send messages
</span><span style=color:#75715e></span>            messenger = Messenger(service)

            <span style=color:#75715e>// send a message
</span><span style=color:#75715e></span>            messenger<span style=color:#f92672>?.</span>send(Message.obtain().apply { what = <span style=color:#ae81ff>777</span> })
        }

        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceDisconnected</span>(name: ComponentName) {
            <span style=color:#75715e>// nullify the messenger in case the service is disconnected unexpectedly,
</span><span style=color:#75715e></span>            <span style=color:#75715e>// e.g. the remote process crashes
</span><span style=color:#75715e></span>            messenger = <span style=color:#66d9ef>null</span>
        }
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onStart</span>() {
        <span style=color:#66d9ef>super</span>.onStart()

        <span style=color:#75715e>// bind the service, and start it if needed
</span><span style=color:#75715e></span>        bindService(Intent(<span style=color:#66d9ef>this</span>, RemoteService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java), connection, BIND_AUTO_CREATE)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onStop</span>() {
        <span style=color:#75715e>// disconnect from the service, and nullify the messenger
</span><span style=color:#75715e></span>        unbindService(connection)
        messenger = <span style=color:#66d9ef>null</span>

        <span style=color:#66d9ef>super</span>.onStop()
    }
}</code></pre></div></p><h3 id=conclusion>Conclusion</h3><p>Hopefully, this article can give you some idea on how some low-level Android components work.</p><p>For most of the time, we probably don&rsquo;t need to directly work with them, but it&rsquo;s important and interesting to know how the platform works, and what tools we can use if needed.</p><div class=blog-tags><a href=https://xizzhu.me//tags/android/>android</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fxizzhu.me%2fpost%2f2020-05-09-android-looper-handler%2f&text=Loopers%20and%20Handlers%20in%20Android&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fxizzhu.me%2fpost%2f2020-05-09-android-looper-handler%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fxizzhu.me%2fpost%2f2020-05-09-android-looper-handler%2f&title=Loopers%20and%20Handlers%20in%20Android" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fxizzhu.me%2fpost%2f2020-05-09-android-looper-handler%2f&title=Loopers%20and%20Handlers%20in%20Android" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fxizzhu.me%2fpost%2f2020-05-09-android-looper-handler%2f&title=Loopers%20and%20Handlers%20in%20Android" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fxizzhu.me%2fpost%2f2020-05-09-android-looper-handler%2f&description=Loopers%20and%20Handlers%20in%20Android" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2021-08-06-android-ble-throughput/>Understanding BLE throughput on Android</a></li><li><a href=/post/2021-06-28-kotlin-multiplatform-mobile-kmm/>Getting started with Kotlin Multiplaform Mobile (KMM)</a></li><li><a href=/post/2021-06-21-android-mvi-kotlin-coroutines-flow-compose/>Model-View-Intent Design Pattern on Android</a></li><li><a href=/post/2020-07-25-dependency-injection-hilt/>Dependency Injection with Hilt</a></li><li><a href=/post/2020-05-18-android-activity-service-communication/>Different ways Activities communicating with Services on Android</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://xizzhu.me/post/2020-05-02-design-patterns-kotlin-behavioral-patterns/ data-toggle=tooltip data-placement=top title="Design Patterns in Kotlin: Behavioral Patterns">&larr; Previous Post</a></li><li class=next><a href=https://xizzhu.me/post/2020-05-14-android-getsystemservice/ data-toggle=tooltip data-placement=top title="How Android apps get handles to system services">Next Post &rarr;</a></li></ul><div class=disqus-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//xizhi-zhu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://github.com/xizzhu title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/xizhizhu title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/1664863/xizzhu title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.youtube.com/c/XizhiZhu title=Youtube><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-youtube fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Xizhi Zhu
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://xizzhu.me/>xizzhu</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://xizzhu.me/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://xizzhu.me/js/load-photoswipe.js></script></body></html>