<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Play with Google Play Services - Push Notification - Xizhi Zhu</title><meta property=og:title content="Play with Google Play Services - Push Notification"><meta name=twitter:title content="Play with Google Play Services - Push Notification"><meta name=description content="If you haven’t set up Google Play services yet, please follow this tutorial. Today, we demonstrate how to use the cloud messaging / push notification."><meta property=og:description content="If you haven’t set up Google Play services yet, please follow this tutorial. Today, we demonstrate how to use the cloud messaging / push notification."><meta name=twitter:description content="If you haven’t set up Google Play services yet, please follow this tutorial. Today, we demonstrate how to use the cloud messaging / push notification."><meta name=author content><link href=https://xizzhu.me/images/logo.png rel=icon type=image/x-icon><meta property=og:image content=https://xizzhu.me/images/logo.png><meta name=twitter:image content=https://xizzhu.me/images/logo.png><meta name=twitter:card content=summary><meta property=og:url content=https://xizzhu.me/posts/2014-02-26-google-play-services-push-notification-cloud-messaging/><meta property=og:type content=website><meta property=og:site_name content="Xizhi Zhu"><meta name=generator content="Hugo 0.50"><link rel=alternate href=https://xizzhu.me/index.xml type=application/rss+xml title="Xizhi Zhu"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://xizzhu.me/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://xizzhu.me/css/syntax.css><link rel=stylesheet href=https://xizzhu.me/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-128400000-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","name":"Play with Google Play Services - Push Notification","headline":"Play with Google Play Services - Push Notification","mainEntityOfPage":{"@type":"WebPage","@id":"https://xizzhu.me/posts/2014-02-26-google-play-services-push-notification-cloud-messaging/"},"description":"If you haven’t set up Google Play services yet, please follow this tutorial. Today, we demonstrate how to use the cloud messaging / push notification. ","inLanguage":"en","copyrightYear":" - 2018","datePublished":"2014-02-26T00:00:00-08:00","dateModified":"2014-02-26T00:00:00-08:00","url":"https://xizzhu.me/posts/2014-02-26-google-play-services-push-notification-cloud-messaging/","wordCount":"598","image":"https://xizzhu.me/images/logo.png","keywords":["android, google-play-services"],"publisher":{"@type":"Organization","name":"https://xizzhu.me/","logo":{"@type":"ImageObject","url":"https://xizzhu.me/images/logo.png","height":60,"width":60}}}</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://xizzhu.me/>Xizhi Zhu</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Posts href=/posts>Posts</a></li><li><a title=Bible href=/bible>Bible</a></li><li><a title=随笔 href=/%e9%9a%8f%e7%ac%94>随笔</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Xizhi Zhu" href=https://xizzhu.me/><img class=avatar-img src=https://xizzhu.me/images/logo.png alt="Xizhi Zhu"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Play with Google Play Services - Push Notification</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>If you haven’t set up Google Play services yet, please follow <a href=/posts/2014-02-07-google-play-services-set-up>this tutorial</a>. Today, we demonstrate how to use the cloud messaging / push notification.</p><h2 id=enable-cloud-messaging-api>Enable Cloud Messaging API</h2><p>First, create a project in <a href=https://console.developers.google.com/project/>Google Developers Console</a> for your app, and enable the <em>Google Cloud Messaging for Android</em> API. The project number will be used as the <strong>GCM sender ID</strong>.</p><p>Then, create a server key in Public API access with your server&rsquo;s IP address (for testing purposes, you can use e.g. <em>0.0.0.0/0</em> to allow anybody to send messages with the generated API key). The generated API key will be used to authenticate your server.</p><p><strong>Note</strong>: For devices running Android older than 4.0.4, it requires users to set up a Google account before using GCM.</p><h2 id=update-androidmanifest-xml>Update AndroidManifest.xml</h2><p>Now, update your <em>AndroidManifest.xml</em> file, specifying the required permissions:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;uses-permission</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.google.android.c2dm.permission.RECEIVE&#34;</span><span style=color:#f92672>/&gt;</span>
 
<span style=color:#f92672>&lt;permission</span>
    <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.example.app.permission.C2D_MESSAGE&#34;</span>
    <span style=color:#a6e22e>android:protectionLevel=</span><span style=color:#e6db74>&#34;signature&#34;</span> <span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;uses-permission</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.example.app.permission.C2D_MESSAGE&#34;</span> <span style=color:#f92672>/&gt;</span></code></pre></div></p><h2 id=register-the-client>Register The Client</h2><p>The following snippet shows how to register a client for cloud messaging:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// this might invoke network calls, so call me in a worker thread
</span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerCloudMessaging</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// repeated calls to this method will return the same token
</span><span style=color:#75715e></span>    <span style=color:#75715e>// a new registration is needed if the app is updated or backup &amp; restore happens
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>final</span> String token <span style=color:#f92672>=</span> InstanceID<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getToken</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-GCM-sender-ID&#34;</span><span style=color:#f92672>,</span>
        GoogleCloudMessaging<span style=color:#f92672>.</span><span style=color:#a6e22e>INSTANCE_ID_SCOPE</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
 
    <span style=color:#75715e>// then uploads the token to your server
</span><span style=color:#75715e></span> 
    <span style=color:#75715e>// or, if the client wants to subscribe to certain topics, use this method
</span><span style=color:#75715e></span>    GcmPubSub<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>).</span><span style=color:#a6e22e>subscribe</span><span style=color:#f92672>(</span>token<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;/topics/your_topic_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
<span style=color:#f92672>}</span></code></pre></div></p><p><strong>Note</strong> that Google’s GCM server doesn’t handle localization nor message scheduling, so the client might also need to upload e.g. the preferred language and timezone to the server to improve user experiences.</p><h2 id=receive-messages>Receive Messages</h2><p>In your <em>AndroidManifest.xml</em>, specify a listener:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;application</span> <span style=color:#960050;background-color:#1e0010>...</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;receiver</span>
        <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;.MyPushNotificationReceiver&#34;</span>
        <span style=color:#a6e22e>android:permission=</span><span style=color:#e6db74>&#34;com.google.android.c2dm.permission.SEND&#34;</span> <span style=color:#f92672>&gt;</span>
        <span style=color:#f92672>&lt;intent-filter&gt;</span>
            <span style=color:#f92672>&lt;action</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.google.android.c2dm.intent.RECEIVE&#34;</span> <span style=color:#f92672>/&gt;</span>
            <span style=color:#f92672>&lt;category</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.example.app&#34;</span> <span style=color:#f92672>/&gt;</span>
        <span style=color:#f92672>&lt;/intent-filter&gt;</span>
    <span style=color:#f92672>&lt;/receiver&gt;</span>
<span style=color:#f92672>&lt;/application&gt;</span></code></pre></div></p><p>Then you can handle the message yourself:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPushNotificationReceiver</span> <span style=color:#66d9ef>extends</span> BroadcastReceiver <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onReceive</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> Intent intent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// a null or &#34;gcm&#34; message type indicates a regular message,
</span><span style=color:#75715e></span>        <span style=color:#75715e>// and you can get the message details as described in section 5
</span><span style=color:#75715e></span>        <span style=color:#75715e>// &#34;deleted_messages&#34; indicates some pending messages are deleted by server
</span><span style=color:#75715e></span>        String messageType <span style=color:#f92672>=</span> intent<span style=color:#f92672>.</span><span style=color:#a6e22e>getStringExtra</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message_type&#34;</span><span style=color:#f92672>);</span>
 
        <span style=color:#75715e>// indicates the sender of the message, or the topic name
</span><span style=color:#75715e></span>        String from <span style=color:#f92672>=</span> intent<span style=color:#f92672>.</span><span style=color:#a6e22e>getStringExtra</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;from&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span></code></pre></div></p><h2 id=send-a-message>Send a Message</h2><p>To send a push message, you can simply send a POST request to Google’s GCM server. The URL of the server is: <em><a href=https://gcm-http.googleapis.com/gcm/send>https://gcm-http.googleapis.com/gcm/send</a></em>.</p><p>The HTTP header must contain the following two:</p><ul><li>Authorization:key=<your-api-key></li><li>Content-Type: application/json</li></ul><p>The HTTP body is a JSON object, something like this:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;to&#34;</span>: <span style=color:#e6db74>&#34;client_registration_id_or_topic_name&#34;</span>,
  <span style=color:#f92672>&#34;data&#34;</span>: {
    <span style=color:#f92672>&#34;key_1&#34;</span>: <span style=color:#e6db74>&#34;value_1&#34;</span>,
    <span style=color:#f92672>&#34;key_2&#34;</span>: <span style=color:#e6db74>&#34;value_2&#34;</span>
  },
  <span style=color:#f92672>&#34;priority&#34;</span>: <span style=color:#e6db74>&#34;normal&#34;</span>
}</code></pre></div></p><p>The fields of the <code>data</code> object represent the key-value pairs of the message&rsquo;s payload data. With the above example, the client will receive an intent with an extra of key <code>key_1</code> and value <code>value_1</code>, and another extra of key <code>key_2</code> and value <code>value_2</code>.</p><p>The <code>priority</code> can be either <code>normal</code> (default) or <code>high</code>. The messages marked as <code>high</code> priority will be sent immediately, even when the device is in <a href=https://developer.android.com/training/monitoring-device-state/doze-standby.html>Doze</a> mode. For <code>normal</code> priority messages, they will be batched for devices in Doze mode, and will be discarded if the message expires while the device is in Doze mode.</p><p>For a complete list of allowed fields in the posted JSON, check <a href=https://developers.google.com/cloud-messaging/http-server-ref>here</a>.</p><p>The response can contain the following status code:</p><ul><li>200: The message is successfully processed.</li><li>400: The request JSON object is malformed.</li><li>401: The sender fails to authenticate itself.</li><li>5xx: Server error, the sender should respect the <code>Retry-After</code> and retry later.</li></ul><p>More details of how to parse the response messages can be found <a href=https://developers.google.com/cloud-messaging/http-server-ref#interpret-downstream>here</a>.</p><p>That’s it for today. Happy hacking!</p><div class=blog-tags><a href=https://xizzhu.me//tags/android/>android</a>&nbsp;
<a href=https://xizzhu.me//tags/google-play-services/>google-play-services</a>&nbsp;</div><h4 class=see-also>See also</h4><ul><li><a href=/posts/2014-02-10-google-play-services-map/>Play with Google Play Services - Map</a></li><li><a href=/posts/2014-02-07-google-play-services-set-up/>Play with Google Play Services - Set Up</a></li><li><a href=/posts/2013-09-09-display-image-efficiently-android/>Displaying Images Efficiently on Android</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://xizzhu.me/posts/2014-02-10-google-play-services-map/ data-toggle=tooltip data-placement=top title="Play with Google Play Services - Map">&larr; Previous Post</a></li><li class=next><a href=https://xizzhu.me/posts/2014-11-10-google-play-services-locations/ data-toggle=tooltip data-placement=top title="Play with Google Play Services - Locations">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://github.com/xizzhu title=GitHub><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/xizhizhu title=LinkedIn><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/1664863/xizzhu title=StackOverflow><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2018
&nbsp;&bull;&nbsp;
<a href=https://xizzhu.me/>Xizhi Zhu</a></p><p class="credits theme-by text-muted">Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> heme, hosted by <a href=https://pages.github.com/>GitHub Pages</a>.</p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js integrity=sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js integrity=sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://xizzhu.me/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://xizzhu.me/js/load-photoswipe.js></script></body></html>